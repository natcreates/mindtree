<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mindtree</title>
</head>
<body>
   <mindtree-app></mindtree-app>
<script type="module">
    import {LitElement, html} from 'https://unpkg.com/lit-element?module';

    const valueForm = (add, removeAll) => html`
       <form>
           <div>
             <label>
               Name
              <input name="name" id="valueName"/>
             </label>
           </div>
          <button @click=${add}>Save</button>
       </form>
       <button @click=${removeAll}>Remove all</button>

    `;

    const valuesList = (values, removeClick) => {
        const content = values.length ? values.map((value) => html`<li>${value.name}<button @click=${removeClick}>X</button></li>`) : 'No values'
        return html`
       <ul>
         ${content}
       </ul>
    `;
    };

    const activitiesForm = (addActivity, values) => {
        if (!values || !values.length) return;
        const options = values.map((value) => html`<option value=${value.value_id}>${value.name}</option>`);
        return html`
       <form>
        <div>
          <label>
            Name
            <input name="name" id="activityName"/>
         </label>
       </div>
       <div>
        <label>
            Value
            <select name="value" id="activityValue">
               ${options}
            </select>
        </label>
        <label>
        Weight
        <input name="weight" type="number" id="activityWeight"/>
        </label>
        </div>
        <button @click=${addActivity}>Save</button>
        </form>
        `;
    };

    const errorMessage = html`<p style="color: red;">There was a problem saving your changes.</p>`;

    class MindtreeApp extends LitElement {
        static get properties() {
            return {
                values: { type: Array },
                activities: { type: Array },
                error: { type: Boolean },
            }
        }
        connectedCallback() {
            super.connectedCallback();
            if (!this.values) {
                this.fetchData();
            }
        }

        async fetchData() {
            const response  = await fetch('/values');
            const json = await response.json();
            this.values = json.values;
            this.activities = json.activities;
        }

        async _addValue(e) {
            e.preventDefault();
            e.stopPropagation();
            const input = this.shadowRoot.getElementById('valueName');
            const name = input.value;
            try {
                await fetch('/values', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name }),
                });
                input.value = '';
                this.values = [
                    ...this.values,
                    { name }
                ];
                this.error = false;
            } catch (error) {
                console.log(error);
                this.error = true;
            }
        }

        _removeValue() {
            return async (valueId) => {
                const input = this.shadowRoot.getElementById('valueName');
                const name = input.value;
                try {
                    const response  = await fetch(`/values/${valueId}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        input.value = '';
                        this.error = false;
                        this.values = [
                            ...this.values,
                            { name }
                        ];
                    }
                } catch (error) {
                    console.log(error);
                    this.error = true;
                }
            }
         }

        async _addActivity(e) {
            e.preventDefault();
            e.stopPropagation();
            const activityNameInput = this.shadowRoot.getElementById('activityName');
            const activityValueInput = this.shadowRoot.getElementById('activityValue');
            const activityWeightInput = this.shadowRoot.getElementById('activityWeight');
            const name = activityNameInput.value;
            const valueId = activityValueInput.value;
            const weight = activityWeightInput.value;
            try {
                const response = await fetch('/activities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, valueId, weight }),
                });
                if (response.ok) {
                    activityNameInput.value = '';
                    activityValueInput.value = '';
                    activityWeightInput.value = '';
                    this.error = false;
                    return this.activities = [
                        ...this.activities,
                        { name, weight, value_id: valueId }
                    ];
                } else {
                    throw error;
                }

            } catch (error) {
                console.log(error);
                this.error = true;
            }
        }

        async _removeAllValues() {
            try {
                const response = await fetch('/values', { method: 'DELETE' });
                if (response.ok) {
                    this.error = false;
                    return this.values = [];
                }
                throw error;
            } catch (error) {
                console.log(error);
                this.error = true;
            }
        }

        render() {
            return html`
               <h2>Values</h2>
               ${valuesList(this.values, this._removeValue)}
               ${valueForm(this._addValue, this._removeAllValues)}
               <h2>Activities</h2>
               ${activitiesForm(this._addActivity, this.values)}

               ${this.error ? errorMessage : ''}
            `;
        }
    }

    customElements.define('mindtree-app', MindtreeApp);
</script>
</body>
</html>
